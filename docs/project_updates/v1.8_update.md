# ğŸ“¢ CORI Update â€“ v1.8: July 25, 2025

ğŸ’» **WEB INTERFACE CONTROL ACHIEVED!** CORI now has a complete **web-based control system** with reverse proxy architecture, password protection, and multi-protocol communication layer. Control your robot from anywhere with full security.

**System Status:** âœ… WORKING  
**Integration Level:** Web UI + Reverse Proxy + Authentication + Real-time Control  

<div align="center">
  <img src="../../assets/imgs/CORI_Web_UI.png" width="80%"/>
  <br><b>CORI Web Interface</b><br>
  <em>Complete Web-Based Robot Control System</em>
</div>

## âœ… What Actually Works

### ğŸ” Secure Access Layer
- âœ… **Nginx Reverse Proxy** running on port 80 with HTTP Basic Auth
- âœ… **Password Protection** via `.htpasswd` file with environment variable support
- âœ… **Security Headers** (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)
- âœ… **Access Control** blocks sensitive files (`.sql`, `.log`, `.conf`)

### ğŸŒ Multi-Protocol Web Interface
- âœ… **FastAPI RESTful API** on port 8000 with full device management
- âœ… **WebSocket Real-time Control** on port 8767 for zero-latency commands
- âœ… **Responsive HTML5 Interface** with mobile-first design
- âœ… **ESP32 Direct WiFi Interface** at 192.168.4.1 for local control

### ğŸ® Interactive Control System
- âœ… **8-Color Command Buttons** (red, orange, yellow, green, blue, purple, grey, black)
- âœ… **Manual Positioning Controls** (left, center, right, look up/down)
- âœ… **Emergency Stop Button** with immediate hardware response
- âœ… **Real-time Servo Sliders** with visual feedback
- âœ… **Connection Status Display** with latency monitoring

### ğŸ”„ Communication Architecture
- âœ… **Multi-layer Protocol Stack** supporting HTTP REST, WebSocket, and Serial
- âœ… **ROS 2 Integration** bridging web commands to robot topics
- âœ… **Auto-device Detection** for ESP32/CH341A hardware
- âœ… **Command History Tracking** with timestamps and success metrics

---

## ğŸ—ï¸ Architecture Overview

### **Reverse Proxy Structure**
```
Internet â†’ Nginx (Port 80) â†’ Password Protection â†’ Route Dispatch
                     â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   "/" â†’ Main UI (Port 8091)         â”‚
              â”‚   "/api/" â†’ FastAPI (Port 8000)     â”‚ 
              â”‚   "/ws" â†’ WebSocket (Port 8767)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Communication Flow**
```
Web Browser â†’ Nginx Proxy â†’ WebSocket/API â†’ ROS 2 Topics â†’ Hardware Bridge â†’ ESP32 â†’ Servos
     â†‘                                                                              â†“
Mobile App â† Real-time Feedback â† Status Updates â† Joint States â† Servo Positions â†â”˜
```

### **Security Layer**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                NGINX GATEWAY                    â”‚
â”‚  â€¢ HTTP Basic Authentication                    â”‚
â”‚  â€¢ Password-protected access                    â”‚
â”‚  â€¢ Security headers injection                   â”‚
â”‚  â€¢ File access restrictions                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             BACKEND SERVICES                    â”‚
â”‚  â€¢ FastAPI (8000) - Device Management           â”‚
â”‚  â€¢ WebSocket (8767) - Real-time Control         â”‚
â”‚  â€¢ ESP32 Direct (192.168.4.1) - Local Access    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ User Interface Components

### **Main Control Dashboard**
**Location:** `index.html` (Responsive HTML5)

**Core Features:**
- **Real-time Connection Status** with WebSocket latency display
- **Emergency Stop Button** - Immediate hardware shutdown
- **System Feedback Panel** with timestamped command responses

### **Color Command Grid**
8 interactive buttons with gradient backgrounds:
```
ğŸ”´ RED     ğŸŸ  ORANGE   ğŸŸ¡ YELLOW   ğŸŸ¢ GREEN
ğŸ”µ BLUE    ğŸŸ£ PURPLE    âšª GREY      âš« BLACK
```
Each button triggers:
- Specific head angle positioning
- Visual confirmation feedback
- Command success/failure status

### **Manual Control Panel**
Direct positioning controls:
- **LEFT** - Pan servo to -90Â°
- **CENTER** - Return to home position (0Â°, 0Â°)  
- **RIGHT** - Pan servo to +90Â°
- **LOOK UP** - Tilt servo to +45Â°
- **LOOK DOWN** - Tilt servo to -45Â°
- **NOD** - Automated nod sequence

### **Servo Control Sliders**
Real-time servo positioning:
- **Horizontal Slider** (Pan): -90Â° to +90Â°
- **Vertical Slider** (Tilt): -45Â° to +45Â°
- **Live Position Feedback** with degree display
- **Smooth Interpolation** prevents servo damage

---

## ğŸ”Œ Communication Protocols

### **1. WebSocket Real-time Control (Port 8767)**
**Protocol:** WebSocket with JSON message format

**Command Structure:**
```javascript
// Send command
ws.send(JSON.stringify({
    command: "color",
    value: "red"
}));

// Receive response
{
    "status": "success",
    "message": "Color command executed",
    "latency": "23ms",
    "timestamp": "2025-07-25T10:30:15Z"
}
```

**Supported Commands:**
- `angle` - Set horizontal position (-90 to +90)
- `tilt` - Set vertical position (-45 to +45)
- `color` - Move to predefined color position
- `hardware` - Send raw hardware command
- `emergency_stop` - Immediate stop all movement
- `status` - Request system status

### **2. FastAPI REST Interface (Port 8000)**
**Protocol:** HTTP REST with JSON responses

**Key Endpoints:**
```bash
# Device Management
GET  /api/status          # System status
POST /api/connect         # Connect to hardware
GET  /api/devices         # List available devices
POST /api/emergency_stop  # Emergency stop

# Control Commands  
POST /api/command         # Send raw command
POST /api/angle          # Set servo angles
POST /api/color          # Color-based positioning

# Monitoring
GET  /api/history        # Command history
GET  /api/colors         # Available color commands
```

### **3. ESP32 Direct Interface (192.168.4.1)**
**Protocol:** HTTP with embedded HTML interface

**Access Method:**
1. Connect to `CORI_HEAD_CONTROLLER` WiFi network
2. Password: `cori123456`
3. Navigate to `http://192.168.4.1`
4. Direct servo control without ROS 2 layer

---

## ğŸ›¡ï¸ Security Implementation

### **Nginx Configuration** (`nginx_cori.conf`)
```nginx
server {
    listen 80;
    server_name _;
    
    # Global authentication
    auth_basic "CORI Robot Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Block sensitive files
    location ~* \.(sql|log|conf)$ {
        deny all;
        return 404;
    }
    
    # Route proxying
    location / {
        proxy_pass http://127.0.0.1:8091;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
    }
    
    location /ws {
        proxy_pass http://127.0.0.1:8767;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### **Authentication Setup** (`setup_nginx.sh`)
```bash
#!/bin/bash
# Create password file
sudo htpasswd -c /etc/nginx/.htpasswd ${CORI_USERNAME:-admin}

# Deploy configuration
sudo cp nginx_cori.conf /etc/nginx/sites-available/cori
sudo ln -sf /etc/nginx/sites-available/cori /etc/nginx/sites-enabled/

# Restart services
sudo systemctl restart nginx
sudo systemctl enable nginx
```

---

## ğŸš€ Getting Started

### **Quick Setup**
```bash
# 1. Setup reverse proxy with authentication
cd cori_ws
./setup_nginx.sh

# 2. Launch all web services
./build.bash
# Select option 7: Web Control Interface

# 3. Access via browser
# Navigate to: http://your-robot-ip
# Username: admin (or CORI_USERNAME env var)
# Password: [prompted during setup]
```

### **Service Management**
```bash
# Check nginx status
sudo systemctl status nginx

# View nginx logs
sudo tail -f /var/log/nginx/access.log

# Test WebSocket connection
wscat -c ws://localhost:8767

# Check FastAPI status
curl http://localhost:8000/api/status
```

### **Environment Variables**
```bash
# Set custom credentials
export CORI_USERNAME="your_username"
export CORI_PASSWORD="your_password"

# Run setup with custom credentials
./setup_nginx.sh
```

---

## ğŸ¯ Real-World Usage Scenarios

### **Remote Robot Control**
- **Internet Access:** Secure access from anywhere via domain/IP
- **Mobile Control:** Responsive design works on phones/tablets
- **Team Access:** Multiple users with shared authentication
- **Development Testing:** API endpoints for automated testing

### **Local Development**
- **ESP32 Direct:** Local WiFi control without internet
- **ROS 2 Integration:** Full robot stack testing
- **Hardware Debugging:** Direct servo control and monitoring
- **Performance Testing:** WebSocket latency measurement

### **Production Deployment**
- **Password Protection:** Secure access to robot controls
- **Reverse Proxy:** Professional web architecture
- **Service Management:** Systemd integration for reliability
- **Monitoring:** Request logging and error tracking

---

## ğŸ’« Technical Achievements

### **âœ… Full-Stack Web Robotics**
- Complete web-to-hardware control pipeline
- Multi-protocol communication (HTTP, WebSocket, Serial)
- Real-time command execution with feedback
- Professional security and proxy configuration

### **âœ… Production-Ready Architecture**
- Nginx reverse proxy with authentication
- Service management and monitoring
- Mobile-responsive interface design
- Comprehensive error handling and recovery

### **âœ… Developer Experience**
- Multiple access methods (direct ESP32, ROS 2 bridge, web API)
- Comprehensive API documentation
- Easy setup scripts and environment management
- Real-time debugging and monitoring tools

---

## ğŸ† Achievement Summary

**v1.8 successfully bridges web interfaces to physical robot control:**

- **Secure Web Access** with password protection and reverse proxy
- **Multi-Protocol Communication** supporting REST, WebSocket, and direct ESP32 control
- **Responsive User Interface** optimized for desktop and mobile
- **Professional Architecture** with nginx, authentication, and service management

### **Success Metrics:**
- **Zero-latency WebSocket control** - Commands execute in <50ms
- **Mobile-responsive design** - Works on phones, tablets, desktops
- **Password-protected access** - Secure remote robot control
- **Multi-user support** - Shared authentication for team access
- **Production-ready deployment** - Systemd integration and monitoring

---

ğŸ¯ **Milestone Achieved:** CORI now has **professional web-based control** accessible from anywhere with full security.

*Complete transition from local-only hardware to internet-accessible robot control platform.*